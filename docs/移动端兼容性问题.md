# 移动端兼容性问题清单

本文档列出了项目中可能存在的移动端浏览器兼容性问题，以及对应的解决方案。

---

## 目录

- [一、CSS 兼容性问题](#一css-兼容性问题)
- [二、JavaScript 兼容性问题](#二javascript-兼容性问题)
- [三、iOS Safari 特有问题](#三ios-safari-特有问题)
- [四、微信/抖音浏览器问题](#四微信抖音浏览器问题)
- [五、视频播放兼容性](#五视频播放兼容性)
- [六、触摸事件与手势](#六触摸事件与手势)
- [七、第三方 SDK 兼容性](#七第三方-sdk-兼容性)
- [八、兼容性检测工具](#八兼容性检测工具)

---

## 一、CSS 兼容性问题

### 1.1 CSS Grid 布局

**问题位置**：`src/views/Home.vue:394-397`

```css
.template-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-lg);
}
```

**兼容性问题**：
- iOS Safari 10.3 以下不支持
- 部分老旧 Android WebView 不支持

**影响的浏览器**：
- iOS 10.3 及以下
- Android 5.0 以下部分机型

**解决方案**：

```css
/* 方案1：添加 flexbox 降级 */
.template-grid {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-lg);
  /* Grid 降级：使用 flexbox */
}

.template-grid > * {
  width: calc(50% - var(--space-lg) / 2);
  margin-bottom: var(--space-lg);
}

/* 方案2：使用 @supports 检测 */
@supports (display: grid) {
  .template-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
  }
  .template-grid > * {
    width: auto;
    margin-bottom: 0;
  }
}
```

---

### 1.2 aspect-ratio 属性

**问题位置**：`src/views/Home.vue:404`

```css
.thumb-wrap {
  aspect-ratio: 157 / 235;
}
```

**兼容性问题**：
- iOS Safari 15 以下不支持
- Android Chrome 88 以下不支持

**影响的浏览器**：
- iOS 15 以下
- Android 10 以下部分机型

**解决方案**：

```css
/* 使用 padding-top hack 替代 */
.thumb-wrap {
  position: relative;
  width: 100%;
  /* 235/157 = 1.4968 */
  padding-top: 149.68%;
  height: 0;
  overflow: hidden;
  border-radius: 0.1rem;
}

.thumb-wrap .thumb {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* 或者使用 @supports 保留原方案 */
@supports (aspect-ratio: 1 / 1) {
  .thumb-wrap {
    padding-top: 0;
    height: 2.34rem;
    aspect-ratio: 157 / 235;
  }
  .thumb-wrap .thumb {
    position: static;
  }
}
```

---

### 1.3 backdrop-filter 属性

**问题位置**：多个组件文件

```css
/* Home.vue, Upload.vue 等多处使用 */
backdrop-filter: blur(7.5px);
-webkit-backdrop-filter: blur(7.5px);
```

**兼容性问题**：
- iOS Safari 9 以下不支持
- Android Chrome 大部分版本不支持
- 低端设备性能问题

**影响的浏览器**：
- iOS 9 以下
- 大部分 Android 设备（虽有 -webkit- 前缀但支持有限）

**解决方案**：

```css
/* 方案1：提供降级背景 */
.glass-effect {
  /* 降级背景 */
  background: rgba(255, 255, 255, 0.85);
  /* 毛玻璃效果 */
  backdrop-filter: blur(7.5px);
  -webkit-backdrop-filter: blur(7.5px);
}

/* 方案2：使用 @supports 检测 */
@supports (backdrop-filter: blur(7.5px)) {
  .glass-effect {
    background: rgba(255, 255, 255, 0.4);
  }
}

@supports not (backdrop-filter: blur(7.5px)) {
  .glass-effect {
    background: rgba(255, 255, 255, 0.9);
  }
}
```

---

### 1.4 CSS gap 属性

**问题位置**：多处使用

```css
gap: var(--space-lg);
```

**兼容性问题**：
- iOS Safari 14.1 以下在 flexbox 中不支持
- Android Chrome 84 以下不支持

**影响的浏览器**：
- iOS 14.1 以下
- Android 10 以下

**解决方案**：

```css
/* 方案1：使用 margin 替代 */
.flex-container {
  display: flex;
  flex-wrap: wrap;
  /* gap: 0.15rem; */
  margin: -0.075rem;
}

.flex-container > * {
  margin: 0.075rem;
}

/* 方案2：使用 CSS 变量 + calc */
.flex-container {
  --gap: 0.15rem;
  display: flex;
  flex-wrap: wrap;
  gap: var(--gap);
}

/* 兼容性降级 */
@supports not (gap: 1px) {
  .flex-container {
    margin: calc(var(--gap) * -0.5);
  }
  .flex-container > * {
    margin: calc(var(--gap) * 0.5);
  }
}
```

---

### 1.5 CSS 自定义属性（CSS Variables）

**问题位置**：`src/assets/theme.css`

```css
:root {
  --color-primary: #e41208;
  /* ... */
}
```

**兼容性问题**：
- IE 11 完全不支持
- Android 4.4.4 以下不支持

**解决方案**：

```css
/* 方案1：提供默认值 */
.button {
  /* 降级值 */
  background-color: #e41208;
  /* CSS 变量 */
  background-color: var(--color-primary, #e41208);
}

/* 方案2：构建时自动降级（使用 postcss-css-variables 插件） */
// vite.config.js
import postcssCssVariables from 'postcss-css-variables'

export default defineConfig({
  css: {
    postcss: {
      plugins: [postcssCssVariables()]
    }
  }
})
```

---

### 1.6 安全区域适配

**问题位置**：`src/assets/theme.css:83-86`

```css
--safe-top: constant(safe-area-inset-top);
--safe-top-env: env(safe-area-inset-top);
--safe-bottom: constant(safe-area-inset-bottom);
--safe-bottom-env: env(safe-area-inset-bottom);
```

**兼容性问题**：
- `constant()` 在 iOS 11.2 以下使用
- `env()` 在 iOS 11.2+ 使用
- Android 部分机型不支持

**解决方案**：

```css
/* 当前实现已正确，但需要确保同时使用 */
.safe-area-bottom {
  padding-bottom: constant(safe-area-inset-bottom); /* iOS 11.0-11.2 */
  padding-bottom: env(safe-area-inset-bottom); /* iOS 11.2+ */
}

/* 添加 JavaScript 降级检测 */
function supportsSafeArea() {
  const div = document.createElement('div')
  div.style.paddingTop = 'env(safe-area-inset-top)'
  document.body.appendChild(div)
  const computed = getComputedStyle(div)
  document.body.removeChild(div)
  return computed.paddingTop !== '0px'
}
```

---

## 二、JavaScript 兼容性问题

### 2.1 ES6+ 语法

**问题位置**：整个项目

```javascript
// 箭头函数、解构、async/await 等大量使用
const { data } = await api.fetch()
```

**兼容性问题**：
- IE 11 不支持
- Android 5.0 以下 WebView 支持有限

**解决方案**：

```javascript
// vite.config.js - 配置转译目标
export default defineConfig({
  build: {
    target: ['es2015', 'safari11'], // 指定目标浏览器
  },
})

// 或使用 browserslist 配置
// package.json
{
  "browserslist": [
    "iOS >= 11",
    "Android >= 5",
    "Chrome >= 60",
    "Safari >= 11"
  ]
}
```

---

### 2.2 navigator.clipboard API

**问题位置**：`src/utils/douyinShare.js:95`

```javascript
if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
  return navigator.clipboard.writeText(text)
}
```

**兼容性问题**：
- iOS 13.4 以下不支持
- 需要 HTTPS 环境
- 部分国产浏览器不支持

**解决方案**：当前代码已有降级方案，无需修改。

```javascript
// 已有的降级方案（保留）
function copyToClipboard(text) {
  if (typeof navigator === 'undefined') return Promise.resolve(false)

  // 现代浏览器 API
  if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
    return navigator.clipboard.writeText(text).then(() => true).catch(() => false)
  }

  // 降级方案：使用 execCommand
  const textarea = document.createElement('textarea')
  textarea.value = text
  textarea.style.position = 'fixed'
  textarea.style.opacity = '0'
  document.body.appendChild(textarea)
  textarea.select()
  try {
    const ok = document.execCommand('copy')
    return Promise.resolve(!!ok)
  } catch (e) {
    return Promise.resolve(false)
  } finally {
    document.body.removeChild(textarea)
  }
}
```

---

### 2.3 IntersectionObserver

**问题位置**：图片懒加载场景

**兼容性问题**：
- iOS Safari 12.2 以下不支持
- Android Chrome 51 以下不支持

**解决方案**：

```javascript
// 添加 polyfill 或降级处理
function createObserver(callback, options = {}) {
  if ('IntersectionObserver' in window) {
    return new IntersectionObserver(callback, options)
  }

  // 降级：直接加载所有图片
  return {
    observe: (el) => callback([{ target: el, isIntersecting: true }]),
    unobserve: () => {},
    disconnect: () => {}
  }
}

// 或者使用 polyfill
// npm install intersection-observer
import 'intersection-observer'
```

---

### 2.4 ResizeObserver

**兼容性问题**：
- iOS Safari 13.1 以下不支持
- Android Chrome 64 以下不支持

**解决方案**：

```javascript
// 添加检测和降级
function observeResize(element, callback) {
  if ('ResizeObserver' in window) {
    const observer = new ResizeObserver(callback)
    observer.observe(element)
    return observer
  }

  // 降级：使用 window resize 事件
  const handler = () => callback([{ target: element }])
  window.addEventListener('resize', handler)
  return { disconnect: () => window.removeEventListener('resize', handler) }
}
```

---

### 2.5 FileReader API

**问题位置**：`src/views/Upload.vue:263-267`

```javascript
const reader = new FileReader()
reader.onload = () => {
  cropImageSrc.value = reader.result
}
reader.readAsDataURL(file)
```

**兼容性问题**：
- 大文件可能导致内存问题
- 某些浏览器对 dataURL 大小有限制

**解决方案**：

```javascript
// 方案1：限制文件大小
const MAX_FILE_SIZE = 10 * 1024 * 1024 // 10MB

function onFileSelect(e) {
  const file = e.target.files?.[0]
  if (!file) return

  // 检查文件大小
  if (file.size > MAX_FILE_SIZE) {
    showToast('图片大小不能超过 10MB')
    return
  }

  // 使用 URL.createObjectURL 替代 FileReader（更高效）
  cropImageSrc.value = URL.createObjectURL(file)
}

// 方案2：图片压缩后再处理
async function compressImage(file, maxWidth = 1024) {
  return new Promise((resolve) => {
    const img = new Image()
    img.onload = () => {
      const canvas = document.createElement('canvas')
      const scale = Math.min(1, maxWidth / img.width)
      canvas.width = img.width * scale
      canvas.height = img.height * scale

      const ctx = canvas.getContext('2d')
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height)

      canvas.toBlob(resolve, 'image/jpeg', 0.8)
    }
    img.src = URL.createObjectURL(file)
  })
}
```

---

## 三、iOS Safari 特有问题

### 3.1 100vh 问题

**问题位置**：多处使用 `min-height: 100vh`

**问题描述**：
- iOS Safari 的 100vh 包含地址栏高度
- 滚动时地址栏隐藏导致页面高度变化

**解决方案**：

```javascript
// 方案1：使用 JavaScript 动态计算 vh
// 在 App.vue 或 main.js 中添加
function setVH() {
  const vh = window.innerHeight * 0.01
  document.documentElement.style.setProperty('--vh', `${vh}px`)
}

// 初始化
setVH()
// 监听变化
window.addEventListener('resize', setVH)
// iOS 特有：监听 orientationchange
window.addEventListener('orientationchange', () => {
  setTimeout(setVH, 100)
})
```

```css
/* CSS 中使用 */
.page-wrap {
  /* 降级值 */
  min-height: 100vh;
  /* JavaScript 计算的值 */
  min-height: calc(var(--vh, 1vh) * 100);
}
```

---

### 3.2 橡皮筋效果（Bounce Scrolling）

**问题描述**：
- iOS Safari 特有的滚动回弹效果
- 可能影响全屏弹窗的体验

**解决方案**：

```css
/* 方案1：禁止整体橡皮筋 */
html, body {
  overscroll-behavior: none;
}

/* 方案2：仅禁止垂直橡皮筋 */
body {
  overscroll-behavior-y: contain;
}

/* 方案3：弹窗内禁止滚动穿透 */
.modal-open {
  position: fixed;
  width: 100%;
  overflow: hidden;
}
```

```javascript
// JavaScript 控制
function preventScrollOnModal(isOpen) {
  if (isOpen) {
    document.body.style.position = 'fixed'
    document.body.style.top = `-${window.scrollY}px`
    document.body.style.width = '100%'
  } else {
    const scrollY = document.body.style.top
    document.body.style.position = ''
    document.body.style.top = ''
    document.body.style.width = ''
    window.scrollTo(0, parseInt(scrollY || '0') * -1)
  }
}
```

---

### 3.3 Input 键盘弹出问题

**问题描述**：
- 软键盘弹出时视口变化
- 输入框可能被键盘遮挡

**解决方案**：

```javascript
// 监听输入框聚焦，滚动到可见区域
function handleInputFocus(event) {
  const input = event.target
  setTimeout(() => {
    input.scrollIntoView({ behavior: 'smooth', block: 'center' })
  }, 300) // 等待键盘弹出
}

// Vue 组件中使用
const inputRef = ref(null)

onMounted(() => {
  if (inputRef.value) {
    inputRef.value.addEventListener('focus', handleInputFocus)
  }
})

onUnmounted(() => {
  if (inputRef.value) {
    inputRef.value.removeEventListener('focus', handleInputFocus)
  }
})
```

---

### 3.4 点击延迟（300ms Delay）

**问题描述**：
- iOS Safari 默认有 300ms 点击延迟
- 影响交互响应性

**解决方案**：

```html
<!-- index.html 中已正确配置 -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
```

当前 `index.html` 已配置 `user-scalable=no`，可消除 300ms 延迟。

---

### 3.5 -webkit- 前缀需求

**问题描述**：
- 部分 CSS 属性在 iOS Safari 需要 -webkit- 前缀

**需要前缀的属性**：

```css
/* 用户选择 */
-webkit-user-select: none;
user-select: none;

/* 触摸行为 */
-webkit-touch-callout: none;

/* 滚动 */
-webkit-overflow-scrolling: touch;

/* 外观 */
-webkit-appearance: none;

/* 毛玻璃 */
-webkit-backdrop-filter: blur(10px);
backdrop-filter: blur(10px);

/* 文字大小调整 */
-webkit-text-size-adjust: 100%;

/* 高亮 */
-webkit-tap-highlight-color: transparent;
```

**解决方案**：使用 Autoprefixer 自动添加前缀

```javascript
// vite.config.js
export default defineConfig({
  css: {
    postcss: {
      plugins: [
        require('autoprefixer')({
          overrideBrowserslist: [
            'iOS >= 11',
            'Android >= 5',
          ]
        })
      ]
    }
  }
})
```

---

## 四、微信/抖音浏览器问题

### 4.1 微信环境检测

**解决方案**：

```javascript
// src/utils/browser.js（新建）
export function getBrowserInfo() {
  const ua = navigator.userAgent

  return {
    isWechat: /MicroMessenger/i.test(ua),
    isWechatMini: /miniProgram/i.test(ua),
    isDouyin: /Aweme|Douyin/i.test(ua),
    isIOS: /iPhone|iPad|iPod/i.test(ua),
    isAndroid: /Android/i.test(ua),
    isMobile: /Mobile/i.test(ua),
  }
}

// 使用示例
import { getBrowserInfo } from '@/utils/browser'

const { isWechat, isIOS } = getBrowserInfo()

if (isWechat && isIOS) {
  // 微信 iOS 特殊处理
}
```

---

### 4.2 微信 JS-SDK 加载

**问题位置**：`index.html:10`

```html
<script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
```

**兼容性问题**：
- 外部脚本加载可能失败
- 非微信环境不需要加载

**解决方案**：

```javascript
// 动态加载微信 SDK
function loadWechatSDK() {
  return new Promise((resolve, reject) => {
    if (!/MicroMessenger/i.test(navigator.userAgent)) {
      resolve(null)
      return
    }

    if (window.wx) {
      resolve(window.wx)
      return
    }

    const script = document.createElement('script')
    script.src = 'https://res.wx.qq.com/open/js/jweixin-1.6.0.js'
    script.onload = () => resolve(window.wx)
    script.onerror = reject
    document.head.appendChild(script)
  })
}

// 使用
loadWechatSDK().then(wx => {
  if (wx) {
    // 初始化微信分享
  }
})
```

---

### 4.3 抖音 SDK 加载

**问题位置**：`index.html:12`

```html
<script src="https://lf3-static.bytednsdoc.com/obj/eden-cn/fljpeh7hozbf/douyin_open/cdn/dy_open_util_v0.0.6.umd.js"></script>
```

**兼容性问题**：
- 外部脚本可能加载失败
- `window.dy_open_util` 可能未定义

**解决方案**：

```javascript
// 在使用前检测
export function buildDouyinShareSchema(sign, imagePath) {
  if (!sign || !imagePath) return ''

  // 检测 SDK 是否加载
  if (!window.dy_open_util) {
    console.warn('抖音 SDK 未加载')
    return ''
  }

  try {
    const schema = window.dy_open_util.serialize({
      share_type: "h5",
      // ...
    })
    return schema
  } catch (e) {
    console.error('抖音分享 Schema 生成失败:', e)
    return ''
  }
}
```

---

### 4.4 微信/抖音内视频播放限制

**问题描述**：
- 微信内置浏览器限制视频自动播放
- 抖音内也有类似限制

**解决方案**：

```vue
<template>
  <video
    ref="videoEl"
    :src="videoUrl"
    :poster="posterUrl"
    loop
    playsinline
    webkit-playsinline
    x5-video-player-type="h5"
    x5-video-player-fullscreen="true"
    @click="togglePlay"
  />
</template>

<script setup>
import { getBrowserInfo } from '@/utils/browser'

const { isWechat, isIOS } = getBrowserInfo()

// 微信 iOS 需要监听 WeixinJSBridgeReady
onMounted(() => {
  if (isWechat && isIOS && typeof WeixinJSBridge !== 'undefined') {
    WeixinJSBridge.invoke('getNetworkType', {}, () => {
      // 微信环境下可以尝试播放
      videoEl.value?.play().catch(() => {})
    })
  }

  // 监听 WeixinJSBridgeReady 事件
  document.addEventListener('WeixinJSBridgeReady', () => {
    videoEl.value?.play().catch(() => {})
  }, false)
})
</script>
```

---

## 五、视频播放兼容性

### 5.1 自动播放限制

**问题描述**：
- iOS Safari 需要用户交互才能播放带声音的视频
- Chrome 也需要用户交互

**解决方案**：

```vue
<template>
  <video
    ref="videoEl"
    :src="videoUrl"
    loop
    muted
    playsinline
    webkit-playsinline
    x5-video-player-type="h5"
  />
</template>

<script setup>
// 静音视频可以自动播放
onMounted(() => {
  if (videoEl.value) {
    videoEl.value.muted = true
    videoEl.value.play().catch(() => {
      // 自动播放失败，显示播放按钮
      showPlayButton.value = true
    })
  }
})

// 用户点击后取消静音
function handleUserPlay() {
  if (videoEl.value) {
    videoEl.value.muted = false
    videoEl.value.play()
  }
}
</script>
```

---

### 5.2 视频格式兼容性

**问题描述**：
- 不同浏览器支持的视频格式不同
- iOS Safari 偏好 MOV/MP4 (H.264)
- Android 支持 WebM

**解决方案**：

```vue
<template>
  <video ref="videoEl" controls>
    <source :src="videoUrlWebM" type="video/webm" />
    <source :src="videoUrlMp4" type="video/mp4" />
    您的浏览器不支持视频播放
  </video>
</template>
```

---

### 5.3 视频全屏问题

**问题描述**：
- iOS Safari 全屏行为特殊
- Android X5 内核全屏处理

**解决方案**：

```vue
<template>
  <video
    ref="videoEl"
    :src="videoUrl"
    playsinline
    webkit-playsinline
    x5-video-player-type="h5"
    x5-video-player-fullscreen="true"
    x5-video-orientation="portraint"
  />
</template>
```

---

## 六、触摸事件与手势

### 6.1 触摸滚动优化

**问题描述**：
- 部分滚动容器在移动端不流畅

**解决方案**：

```css
/* 启用硬件加速滚动 */
.scroll-container {
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  /* 防止 iOS 橡皮筋 */
  overscroll-behavior: contain;
}
```

---

### 6.2 触摸事件穿透

**问题描述**：
- 弹窗关闭后点击事件可能穿透到下层

**解决方案**：

```javascript
// 弹窗关闭时处理
function closeModal() {
  showModal.value = false
  // 阻止后续点击事件
  document.body.style.pointerEvents = 'none'
  setTimeout(() => {
    document.body.style.pointerEvents = ''
  }, 300)
}
```

---

### 6.3 长按事件

**问题描述**：
- 移动端长按触发菜单选择

**解决方案**：

```css
/* 禁止长按菜单 */
.no-context-menu {
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}
```

```javascript
// 自定义长按事件
function useLongPress(element, callback, duration = 500) {
  let timer = null

  const start = (e) => {
    timer = setTimeout(() => {
      callback(e)
    }, duration)
  }

  const end = () => {
    if (timer) {
      clearTimeout(timer)
      timer = null
    }
  }

  onMounted(() => {
    element.value?.addEventListener('touchstart', start, { passive: true })
    element.value?.addEventListener('touchend', end)
    element.value?.addEventListener('touchmove', end)
    element.value?.addEventListener('touchcancel', end)
  })

  onUnmounted(() => {
    element.value?.removeEventListener('touchstart', start)
    element.value?.removeEventListener('touchend', end)
    element.value?.removeEventListener('touchmove', end)
    element.value?.removeEventListener('touchcancel', end)
  })
}
```

---

## 七、第三方 SDK 兼容性

### 7.1 Cropper.js 兼容性

**问题描述**：
- 移动端触摸事件处理
- 双指缩放可能冲突

**解决方案**：

```javascript
// Cropper 配置优化
cropperInstance = new Cropper(cropImgRef.value, {
  aspectRatio: 1,
  viewMode: 1,
  dragMode: 'move',
  autoCropArea: 1,
  // 移动端优化
  zoomOnTouch: true,
  zoomOnWheel: false, // 防止与页面滚动冲突
  toggleDragModeOnDblclick: false,
  // 触摸优化
  checkCrossOrigin: false,
  checkOrientation: false, // 跳过 EXIF 检测，提升性能
})
```

---

### 7.2 html2canvas 兼容性

**问题描述**：
- 移动端性能较差
- 可能导致页面卡顿

**解决方案**：

```javascript
// 优化配置
const canvas = await html2canvas(element, {
  useCORS: true,
  allowTaint: true,
  scale: 1, // 固定缩放，避免移动端过大的 canvas
  backgroundColor: '#fff',
  logging: false,
  foreignObjectRendering: false,
  // 忽略某些元素
  ignoreElements: (el) => {
    return el.classList.contains('ignore-in-canvas')
  },
})
```

---

### 7.3 QRCode.js 兼容性

**问题描述**：
- Canvas 渲染在某些设备可能模糊

**解决方案**：

```javascript
// 使用更高的 DPI
const dpr = window.devicePixelRatio || 1
const size = 200

QRCode.toCanvas(canvas, text, {
  width: size * dpr,
  margin: 2,
  errorCorrectionLevel: 'M',
}, (error) => {
  if (error) return
  // 缩放回原始大小
  canvas.style.width = `${size}px`
  canvas.style.height = `${size}px`
})
```

---

## 八、兼容性检测工具

### 8.1 浏览器特性检测

```javascript
// src/utils/featureDetect.js（新建）

export const features = {
  // CSS 特性
  cssGrid: CSS.supports('display', 'grid'),
  cssFlexGap: CSS.supports('gap', '1px'),
  cssAspectRatio: CSS.supports('aspect-ratio', '1/1'),
  cssBackdropFilter: CSS.supports('backdrop-filter', 'blur(1px)'),
  cssEnv: (() => {
    try {
      return CSS.supports('top', 'env(safe-area-inset-top)')
    } catch {
      return false
    }
  })(),

  // JS API
  intersectionObserver: 'IntersectionObserver' in window,
  resizeObserver: 'ResizeObserver' in window,
  clipboard: 'clipboard' in navigator,
  serviceWorker: 'serviceWorker' in navigator,

  // 媒体能力
  webp: (() => {
    const canvas = document.createElement('canvas')
    canvas.width = canvas.height = 1
    return canvas.toDataURL('image/webp').startsWith('data:image/webp')
  })(),

  // 触摸支持
  touch: 'ontouchstart' in window,

  // 设备信息
  dpr: window.devicePixelRatio || 1,
}

// 根据特性加载 polyfill
export async function loadPolyfills() {
  const promises = []

  if (!features.intersectionObserver) {
    promises.push(import('intersection-observer'))
  }

  if (!features.resizeObserver) {
    promises.push(import('resize-observer-polyfill'))
  }

  await Promise.all(promises)
}
```

### 8.2 推荐测试设备/环境

| 类别 | 测试项 |
|------|--------|
| iOS Safari | iPhone 8 (iOS 15), iPhone X (iOS 16), iPhone 14 (iOS 17) |
| iOS 微信 | 微信内置浏览器 |
| Android Chrome | Pixel (Android 13), 三星 (Android 12) |
| Android 微信 | 微信内置浏览器 |
| Android 抖音 | 抖音内置浏览器 |
| 国产浏览器 | UC、QQ 浏览器、华为浏览器 |

---

## 问题优先级

| 优先级 | 问题 | 影响范围 | 建议 |
|--------|------|----------|------|
| **高** | aspect-ratio 不兼容 | iOS 15 以下 | 立即修复 |
| **高** | 100vh 问题 | iOS Safari | 立即修复 |
| **高** | 视频自动播放限制 | 所有移动端 | 立即处理 |
| **高** | CSS Grid 降级 | 老旧设备 | 添加降级 |
| **中** | backdrop-filter 降级 | Android 设备 | 添加降级背景 |
| **中** | SDK 加载失败处理 | 微信/抖音环境 | 添加错误处理 |
| **中** | 触摸滚动优化 | 所有移动端 | 添加 CSS 优化 |
| **低** | gap 属性降级 | iOS 14 以下 | 可选修复 |
| **低** | 橡皮筋效果 | iOS Safari | 可选处理 |

---

*文档更新时间：2026-02-27*
