# H5 项目服务器部署说明

本项目为 Vue 3 + Vite 构建的 H5 应用，部署时在服务器上构建出静态文件，由 Nginx 托管。

---

## 一、查看系统信息

在服务器上执行以下命令确认系统类型和版本，便于选择对应的安装命令。

```bash
# 查看系统类型与版本（含 CentOS/Ubuntu/Debian 等）
cat /etc/os-release

# 查看内核与架构
uname -a

# 查看是否为 64 位
getconf LONG_BIT
```

常见输出示例：
- **CentOS / Rocky / Alma**：`ID=centos` 或 `ID="rocky"`，用 `yum` 或 `dnf`
- **Ubuntu / Debian**：`ID=ubuntu` 或 `ID=debian`，用 `apt`

---

## 二、安装 Nginx

### 2.1 CentOS / Rocky / Alma（yum/dnf）

```bash
# 安装 Nginx
sudo yum install -y nginx
# 或（新版本）
sudo dnf install -y nginx

# 启动并设置开机自启
sudo systemctl start nginx
sudo systemctl enable nginx

# 查看状态
sudo systemctl status nginx
```

### 2.2 Ubuntu / Debian（apt）

```bash
# 更新包索引
sudo apt update

# 安装 Nginx
sudo apt install -y nginx

# 启动并设置开机自启
sudo systemctl start nginx
sudo systemctl enable nginx

# 查看状态
sudo systemctl status nginx
```

安装成功后，在浏览器访问 `http://服务器IP`，能看到 Nginx 默认欢迎页即表示 Nginx 已正常运行。

---

## 三、安装 Node.js（用于在服务器上构建项目）

若你选择在服务器上执行 `pnpm build`，需要先安装 Node.js 和 pnpm。

### 3.1 使用 NodeSource 安装 Node.js 20（推荐）

```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# CentOS/Rocky
curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
sudo yum install -y nodejs
```

### 3.2 安装 pnpm

```bash
sudo npm install -g pnpm
```

### 3.3 验证

```bash
node -v   # 应显示 v20.x.x
pnpm -v   # 应显示 9.x.x
```

---

## 四、部署项目

### 4.1 上传代码并构建（在服务器上）

```bash
# 进入项目目录（按你实际路径修改）
cd /path/to/h5

# 安装依赖
pnpm install

# 构建生产包（输出到 dist 目录）
pnpm run build
```

构建完成后，静态文件在项目根目录下的 **`dist`** 目录中。

### 4.2 若在本地构建后上传

在本地执行：

```bash
pnpm install
pnpm run build
```

然后将整个 **`dist`** 目录上传到服务器，例如放到 `/var/www/h5`（目录可自定）。

---

## 五、配置 Nginx 托管静态资源

### 5.1 使用项目自带的 Nginx 配置

项目已包含 Nginx 配置：**`nginx/h5.conf`**。部署时可直接复制到服务器后按需修改。

**Ubuntu/Debian：**

```bash
sudo cp /path/to/h5/nginx/h5.conf /etc/nginx/sites-available/h5
sudo ln -s /etc/nginx/sites-available/h5 /etc/nginx/sites-enabled/
```

**CentOS/Rocky：**

```bash
sudo cp /path/to/h5/nginx/h5.conf /etc/nginx/conf.d/h5.conf
```

复制后编辑该文件，修改 `server_name` 和 `root`（见下节）。

### 5.2 必须修改的配置项

打开复制后的配置文件，修改两处：

- **`server_name`**：改为你的域名或服务器 IP，如 `www.example.com` 或 `123.45.67.89`
- **`root`**：改为服务器上 **dist 目录的真实路径**（或上传后的目录，如 `/var/www/h5`）

配置内已包含 Vue Router history 模式的 `try_files` 和静态资源缓存，无需再写。

### 5.3 启用配置并重载 Nginx

```bash
sudo nginx -t
sudo systemctl reload nginx
```

**CentOS/Rocky：**

```bash
sudo nginx -t
sudo systemctl reload nginx
```

### 5.4 若在服务器上构建，复制 dist 到站点目录

```bash
# 示例：项目在 /home/user/h5，站点目录为 /var/www/h5
sudo mkdir -p /var/www/h5
sudo cp -r /home/user/h5/dist/* /var/www/h5/
# 若使用非 root 用户部署，注意目录权限
sudo chown -R nginx:nginx /var/www/h5
# 或
sudo chown -R www-data:www-data /var/www/h5
```

（CentOS 常见用户为 `nginx`，Ubuntu 为 `www-data`，可用 `ps aux | grep nginx` 查看运行用户。）

---

## 六、防火墙放行 80 端口（如已开启防火墙）

```bash
# firewalld（CentOS/Rocky）
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --reload

# ufw（Ubuntu）
sudo ufw allow 80
sudo ufw reload
```

---

## 七、HTTPS（可选）

若使用域名并需要 HTTPS，可安装 certbot 申请免费证书：

```bash
# Ubuntu
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d 你的域名

# CentOS/Rocky
sudo yum install -y certbot python3-certbot-nginx
# 或 dnf
sudo dnf install -y certbot python3-certbot-nginx
sudo certbot --nginx -d 你的域名
```

按提示选择是否重定向 HTTP 到 HTTPS 即可。

---

## 八、常用命令速查

| 操作           | 命令 |
|----------------|------|
| 查看 Nginx 状态 | `sudo systemctl status nginx` |
| 启动 Nginx     | `sudo systemctl start nginx` |
| 停止 Nginx     | `sudo systemctl stop nginx` |
| 重载配置       | `sudo systemctl reload nginx` |
| 测试配置       | `sudo nginx -t` |
| 查看错误日志   | `sudo tail -f /var/log/nginx/error.log` |

---

## 九、部署流程小结

1. **查看系统**：`cat /etc/os-release`，确认用 yum/dnf 还是 apt。
2. **安装 Nginx**：按系统选择上面第二节对应命令。
3. **（可选）安装 Node + pnpm**：若在服务器构建，按第三节操作。
4. **构建或上传**：在服务器 `pnpm run build` 或本机构建后上传 `dist`。
5. **配置 Nginx**：`root` 指向 `dist` 所在目录，`try_files` 含 `/index.html`。
6. **重载 Nginx**：`sudo nginx -t && sudo systemctl reload nginx`。
7. **防火墙**：放行 80（及 443 若用 HTTPS）。

按以上步骤即可在服务器上通过 Nginx 部署本 H5 项目。
